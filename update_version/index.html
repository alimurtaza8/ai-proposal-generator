<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Proposal Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark-green: #163a30;
            --bg-charcoal: #1a1a1a;
            --text-light: #f8f9fa;
            --text-muted: #adb5bd;
            --accent-tan: #b98b40;
            --accent-tan-hover: #c99c50;
            --border-color: #495057;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-dark-green);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 5%;
            width: 100%;
            background-color: var(--bg-dark-green);
        }
        .navbar-logo img {
            height: 100px;
            color: #ffffff;
        }
        .navbar-links {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        .navbar-links a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }
        .navbar-links a:hover {
            color: var(--accent-tan);
        }
        .contact-button {
            background-color: var(--accent-tan);
            color: var(--text-light);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .contact-button:hover {
            background-color: var(--accent-tan-hover);
        }

        .hero {
            text-align: center;
            padding: 4rem 2rem;
        }
        .hero h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 1rem;
        }
        .hero-subtitle {
            font-size: 1.25rem;
            color: var(--text-muted);
            max-width: 600px;
            margin: 1rem auto 0 auto;
            line-height: 1.6;
        }

        .main-content {
            background-color: var(--bg-charcoal);
            padding: 4rem 2rem;
        }
        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            animation: slideInUp 0.8s cubic-bezier(.4,0,.2,1);
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(60px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group { margin-bottom: 1.4rem; }
        label { display: block; margin-bottom: 0.7rem; font-weight: 600; color: var(--text-muted); font-size: 0.97rem; }
        input[type="text"], select, textarea {
            width: 100%; padding: 1rem 1.1rem; border: 1px solid var(--border-color); border-radius: 8px;
            font-size: 1rem; background: #2c2c2c; color: var(--text-light); transition: all 0.2s;
        }
        input[type="text"]:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--accent-tan); box-shadow: 0 0 0 2px #b98b4033;
        }
        input[type="file"] {
            border: 2px dashed var(--border-color); background: #2c2c2c; cursor: pointer; padding: 1rem;
            border-radius: 12px; font-size: 1rem; transition: border-color 0.2s; color: var(--text-muted);
        }
        input[type="file"]:hover { border-color: var(--accent-tan); }
        textarea { resize: vertical; min-height: 100px; font-family: inherit; }
        
        .submit-button {
            width: 100%; padding: 1.1rem 2rem; background-color: var(--accent-tan);
            color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; transition: all 0.3s cubic-bezier(.4,0,.2,1); margin-top: 1.2rem;
            display: flex; align-items: center; justify-content: center; gap: 0.7rem;
        }
        .submit-button:hover { background-color: var(--accent-tan-hover); transform: translateY(-2px); }
        .submit-button.loading { pointer-events: none; opacity: 0.8; }
        .submit-button.loading i { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        
        .status-container, .download-container {
            margin-top: 2.2rem; text-align: center; animation: fadeIn 0.5s cubic-bezier(.4,0,.2,1);
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .status-message { font-size: 1.1rem; font-weight: 500; color: var(--text-muted); margin-bottom: 1.2rem; }
        .status-message.error { color: #ff6b6b; }
        .progress-container { position: relative; width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 1rem; }
        .progress-bar-inner {
            height: 100%; width: 0%; background: var(--accent-tan);
            border-radius: 5px; transition: width 0.4s cubic-bezier(.4,0,.2,1);
        }
        
        .download-links {
            display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;
        }
        .download-links a {
            display: inline-flex; align-items: center; gap: 0.5rem; padding: 1rem 2rem;
            background: #48bb78; color: white; text-decoration: none;
            border-radius: 12px; font-weight: 600; transition: all 0.3s;
        }
        .download-links a:hover { transform: translateY(-2px); }
        .download-links a.pdf { background: #e53e3e; }
        .download-links a.excel { background: #3182ce; }
        
        .hidden { display: none; }
        .footer {
            text-align: center; color: var(--text-muted); font-size: 1rem; padding: 3rem 0;
        }
        @media (max-width: 768px) {
            .navbar-links { display: none; } /* Simple responsive nav for now */
            .hero h1 { font-size: 2.2rem; }
        }

        .retry-button {
            background-color: #ff6b6b; color: white; padding: 0.8rem 1.5rem; border: none;
            border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 1rem;
            transition: background-color 0.3s;
        }
        .retry-button:hover { background-color: #ff5252; }
        
        .help-text {
            display: block; color: #666; font-size: 0.85rem; margin-top: 0.3rem;
            font-style: italic; line-height: 1.3;
        }
    </style>
</head>
<body>
    <section class="hero">
        <h1>AI Proposal Generator</h1>
        <p class="hero-subtitle">Transform your RFPs into professional proposals in minutes with the power of AI.</p>
    </section>

    <main class="main-content">
        <div class="container">
            <form id="proposal-form">
                <div class="form-group">
                    <label for="company-name"><i class="fa-solid fa-building"></i> Client Name</label>
                    <input type="text" id="company-name" name="company_name" required placeholder="Enter your client name">
                </div>
                <div class="form-group">
                    <label for="proposal-type"><i class="fa-solid fa-file-alt"></i> Proposal Type</label>
                    <select id="proposal-type" name="proposal_type" required>
                        <option value="technical">Technical</option>
                        <option value="financial">Financial</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sector"><i class="fa-solid fa-industry"></i> Sector</label>
                    <select id="sector" name="sector" required>
                        <option value="health">Health</option>
                        <option value="governance">Governance</option>
                        <option value="education">Education</option>
                        <option value="technology">Technology</option>
                        <option value="energy">Energy</option>
                        <option value="transportation">Transportation</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
               
                <div class="form-group">
                    <label for="language"><i class="fa-solid fa-language"></i> Language</label>
                    <select id="language" name="language">
                        <option value="en">English</option>
                        <option value="ar">Arabic</option>
                    </select>
                </div>
                
                
                <div class="form-group">
                    <label for="logo-top-left"><i class="fa-solid fa-image"></i> Top-Left Logo</label>
                    <input type="file" id="logo-top-left" name="logo_top_left" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="logo-bottom-right"><i class="fa-solid fa-image"></i> Bottom-Right Logo</label>
                    <input type="file" id="logo-bottom-right" name="logo_bottom_right" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="files"><i class="fa-solid fa-upload"></i> RFP Documents</label>
                    <input type="file" id="files" name="files" multiple required>
                    <small class="help-text">Upload the main RFP documents that define the project requirements</small>
                </div>
                

               
                <button type="submit" class="submit-button" id="submit-button"><i class="fa-solid fa-magic"></i> Generate Proposal</button>
            </form>
            <div id="status-container" class="status-container hidden">
                <p id="status-message" class="status-message"></p>
                <div class="progress-container">
                    <div id="progress-bar-inner" class="progress-bar-inner"></div>
                </div>
                <button id="retry-button" class="retry-button hidden">Retry Generation</button>
            </div>
            <div id="download-container" class="download-container hidden">
                <h2 style="margin-bottom: 1rem;">Download Your Proposal</h2>
                <div id="download-links" class="download-links"></div>
            </div>
        </div>
    </main>
    <footer class="footer">
        &copy; 2025 AI Proposal Generator. Powered by Maaz Mansoor<br>
        <a style="color: var(--text-muted);" href="https://www.linkedin.com/in/maazomansoor/" target="_blank">LinkedIn</a> |
        <a style="color: var(--text-muted);" href="mailto:Maazmansoorb301@gmail.com">Maazmansoorb301@gmail.com</a>
    </footer>

    <script>
        const form = document.getElementById('proposal-form');
        const statusContainer = document.getElementById('status-container');
        const statusMessage = document.getElementById('status-message');
        const progressBar = document.getElementById('progress-bar-inner');
        const downloadContainer = document.getElementById('download-container');
        const downloadLinks = document.getElementById('download-links');
        const submitButton = document.querySelector('.submit-button');
        const retryButton = document.getElementById('retry-button');
        const API_BASE_URL = 'http://localhost:8000';
        
        let currentJobId = null;
        let pollInterval = null;

        // Helper function to safely extract error message
        function getErrorMessage(error) {
            if (typeof error === 'string') {
                return error;
            }
            if (error && typeof error === 'object') {
                // Try different properties that might contain the error message
                if (error.message && typeof error.message === 'string') {
                    return error.message;
                }
                if (error.detail && typeof error.detail === 'string') {
                    return error.detail;
                }
                if (error.error && typeof error.error === 'string') {
                    return error.error;
                }
                // If it's an object, try to stringify it safely
                try {
                    return JSON.stringify(error);
                } catch (e) {
                    return 'Unknown error occurred';
                }
            }
            return 'Unknown error occurred';
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await startGeneration();
        });

        retryButton.addEventListener('click', async () => {
            await startGeneration();
        });

        async function startGeneration() {
            // Prevent multiple simultaneous submissions
            if (submitButton.classList.contains('loading')) {
                console.log('Generation already in progress, ignoring duplicate request');
                return;
            }

            try {
                submitButton.classList.add('loading');
                submitButton.innerHTML = '<i class="fa-solid fa-spinner"></i> Generating...';
                statusContainer.classList.remove('hidden');
                downloadContainer.classList.add('hidden');
                retryButton.classList.add('hidden');
                downloadLinks.innerHTML = '';
                statusMessage.textContent = 'Uploading files and starting process...';
                statusMessage.classList.remove('error');
                progressBar.style.width = '0%';

                // Clear any existing polling
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }

                const formData = new FormData(form);
                
                console.log('Sending request to:', `${API_BASE_URL}/upload-and-generate`);
                
                const response = await fetch(`${API_BASE_URL}/upload-and-generate`, {
                    method: 'POST',
                    body: formData,
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                        console.log('Error data:', errorData);
                    } catch (parseError) {
                        console.log('Failed to parse error response:', parseError);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    throw new Error(getErrorMessage(errorData));
                }

                const data = await response.json();
                console.log('Success data:', data);
                
                currentJobId = data.job_id;
                statusMessage.textContent = data.message || 'Processing started successfully';
                pollJobStatus(data.job_id);
                
            } catch (error) {
                console.error('Generation error:', error);
                const errorMsg = getErrorMessage(error);
                statusMessage.textContent = `Error generating proposal: ${errorMsg}`;
                statusMessage.classList.add('error');
                retryButton.classList.remove('hidden');
                resetSubmitButton();
            }
        }

        function resetSubmitButton() {
            submitButton.classList.remove('loading');
            submitButton.innerHTML = '<i class="fa-solid fa-magic"></i> Generate Proposal';
        }

        function pollJobStatus(jobId) {
            // Clear any existing interval
            if (pollInterval) {
                clearInterval(pollInterval);
            }

            pollInterval = setInterval(async () => {
                try {
                    console.log('Polling status for job:', jobId);
                    
                    const response = await fetch(`${API_BASE_URL}/status/${jobId}`);
                    
                    if (!response.ok) {
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (parseError) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        throw new Error(getErrorMessage(errorData));
                    }

                    const data = await response.json();
                    console.log('Status data:', data);
                    
                    statusMessage.textContent = data.message || 'Processing...';
                    let progressValue = data.progress || 0;
                    progressBar.style.width = `${progressValue}%`;
                    
                    if (data.status === 'completed') {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        resetSubmitButton();
                        statusMessage.classList.remove('error');
                        displayDownloadLinks(data.files);
                    } else if (data.status === 'error') {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        const errorMsg = getErrorMessage(data);
                        statusMessage.textContent = `Error: ${errorMsg}`;
                        statusMessage.classList.add('error');
                        retryButton.classList.remove('hidden');
                        resetSubmitButton();
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    clearInterval(pollInterval);
                    pollInterval = null;
                    const errorMsg = getErrorMessage(error);
                    statusMessage.textContent = `Error checking status: ${errorMsg}`;
                    statusMessage.classList.add('error');
                    retryButton.classList.remove('hidden');
                    resetSubmitButton();
                }
            }, 2000); // Poll every 2 seconds instead of 3 for better responsiveness
        }

        function displayDownloadLinks(files) {
            // Clear any existing download links first
            downloadLinks.innerHTML = '';
            
            if (files && Array.isArray(files) && files.length > 0) {
                downloadContainer.classList.remove('hidden');
                files.forEach((filename, index) => {
                    if (typeof filename === 'string' && filename.trim()) {
                        const link = document.createElement('a');
                        link.href = `${API_BASE_URL}/download/${encodeURIComponent(filename)}`;
                        
                        if (filename.endsWith('.pdf')) {
                            link.innerHTML = '<i class="fa-solid fa-file-pdf"></i> PDF';
                            link.classList.add('pdf');
                        } else if (filename.endsWith('.docx')) {
                            link.innerHTML = '<i class="fa-solid fa-file-word"></i> Word';
                        } else if (filename.endsWith('.xlsx')) {
                            link.innerHTML = '<i class="fa-solid fa-file-excel"></i> Excel';
                            link.classList.add('excel');
                        } else {
                            link.innerHTML = `<i class="fa-solid fa-file"></i> ${filename}`;
                        }
                        
                        link.setAttribute('download', '');
                        link.style.animationDelay = `${index * 0.1}s`;
                        downloadLinks.appendChild(link);
                    }
                });
                
                if (downloadLinks.children.length === 0) {
                    statusMessage.textContent = "Processing complete, but no valid files were generated.";
                    statusMessage.classList.add('error');
                    retryButton.classList.remove('hidden');
                }
            } else {
                statusMessage.textContent = "Processing complete, but no files were generated. Please check your selections.";
                statusMessage.classList.add('error');
                retryButton.classList.remove('hidden');
            }
        }

        // Auto-scroll to status when form is submitted
        form.addEventListener('submit', () => {
            setTimeout(() => {
                statusContainer.scrollIntoView({ behavior: 'smooth' });
            }, 500);
        });

                 // Clean up intervals when page is unloaded
         window.addEventListener('beforeunload', () => {
             if (pollInterval) {
                 clearInterval(pollInterval);
             }
         });
    </script>
</body>
</html>